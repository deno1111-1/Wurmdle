<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lenis coole Spielesammlung</title>
    <style>
        /* --- GLOBAL --- */
        :root { --col-count: 5; --game-count: 4; }
        body {
            background-color: #121213; color: white;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            margin: 0; display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; user-select: none;
        }

        /* HEADER */
        header {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 10px 15px; background: #121213;
            border-bottom: 1px solid #333; height: 60px; z-index: 10;
        }
        h1 { margin: 0; font-size: 1.0rem; color: #538d4e; text-shadow: 1px 1px 0 #000; }
        .menu-btn {
            background: #333; color: white; border: 1px solid #555;
            padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.8rem;
        }

        /* --- HAUPTMEN√ú --- */
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121213; z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 30px;
        }
        .mode-card {
            background: #1e1e1f; border: 2px solid #538d4e; border-radius: 20px;
            padding: 25px; width: 85%; max-width: 320px; text-align: center;
            cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .mode-card:active { transform: scale(0.95); }
        .mode-icon { font-size: 3.5rem; margin-bottom: 10px; display: block; }
        .mode-title { font-size: 1.5rem; font-weight: bold; color: white; }
        .mode-desc { color: #888; font-size: 0.9rem; margin-top: 5px; }

        /* --- LANG SELECT MODAL (NEU) --- */
        #lang-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 300; display: none;
            flex-direction: column; justify-content: center; align-items: center; gap: 20px;
        }
        .lang-card {
            background: #333; padding: 20px 40px; border-radius: 15px; border: 2px solid #aaa;
            font-size: 1.5rem; font-weight: bold; cursor: pointer; width: 200px; text-align: center;
        }
        .lang-card:hover { background: #444; border-color: white; }

        /* --- SETUP AREA (WORDLE) --- */
        #setup-area {
            flex-grow: 1; display: none; flex-direction: column;
            justify-content: center; align-items: center; gap: 15px;
            width: 100%; padding: 20px; box-sizing: border-box;
        }
        .setting-row { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 100%; }
        .label { color: #888; font-size: 0.9rem; text-transform: uppercase; }
        .toggle-group { display: flex; background: #333; border-radius: 10px; padding: 4px; }
        .lang-btn { background: transparent; border: none; color: #aaa; padding: 10px 20px; font-weight: bold; border-radius: 8px; }
        .lang-btn.active { background: #538d4e; color: white; }
        input[type="number"] {
            padding: 10px; font-size: 1.3rem; width: 100px; text-align: center;
            background: #222; border: 2px solid #538d4e; color: white; border-radius: 10px;
        }
        .start-btn {
            background-color: #538d4e; padding: 15px 50px; font-size: 1.5rem;
            border: none; color: white; font-weight: bold; border-radius: 30px; margin-top: 20px;
            box-shadow: 0 5px 15px rgba(83, 141, 78, 0.4);
        }

        /* --- GAME: WURMDLE --- */
        #game-scroll-area {
            flex-grow: 1; overflow-y: auto; width: 100%; display: none;
            justify-content: center; padding: 20px 0;
        }
        #game-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 25px;
            width: 100%; max-width: 1200px; padding-bottom: 50px;
        }
        .board-card {
            background: #1e1e1f; border: 2px solid #444; border-radius: 12px;
            padding: 10px; display: flex; flex-direction: column; align-items: center;
        }
        .board { display: grid; grid-template-columns: repeat(var(--col-count), 1fr); gap: 4px; }
        .tile {
            width: 34px; height: 34px; border: 2px solid #3a3a3c;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; font-weight: bold; text-transform: uppercase;
            background: #121213; border-radius: 4px;
        }
        .correct { background-color: #538d4e; border-color: #538d4e; }
        .present { background-color: #b59f3b; border-color: #b59f3b; }
        .absent { background-color: #3a3a3c; border-color: #3a3a3c; }
        .shake-effect { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); border-color: #3a3a3c; }
            20%, 60% { transform: translateX(-5px); border-color: #ff5555; }
            40%, 80% { transform: translateX(5px); border-color: #ff5555; }
        }

        /* --- GAME: LILLY SPELLING (HEX) --- */
        #lilly-area {
            flex-grow: 1; width: 100%; display: none; flex-direction: column;
            align-items: center; padding: 10px; box-sizing: border-box; overflow-y: auto;
        }
        #lilly-input {
            font-size: 2rem; font-weight: bold; color: white; min-height: 50px;
            border-bottom: 2px solid #555; margin-bottom: 20px; text-transform: uppercase;
            width: 80%; text-align: center;
        }
        .cursor { animation: blink 1s infinite; border-right: 2px solid #538d4e; }
        @keyframes blink { 50% { opacity: 0; } }

        #honeycomb {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            width: 280px; height: 260px; position: relative;
        }
        .hex-btn {
            width: 80px; height: 70px; background: #e0e0e0; color: #121213;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; font-weight: bold; cursor: pointer;
            position: absolute; transition: transform 0.1s;
        }
        .hex-btn:active { transform: scale(0.9); }
        .hex-center { background: #ffd700; color: black; z-index: 2; }
        
        .pos-0 { top: 35%; left: 35%; }
        .pos-1 { top: 5%; left: 35%; }
        .pos-2 { top: 20%; left: 63%; }
        .pos-3 { top: 50%; left: 63%; }
        .pos-4 { top: 65%; left: 35%; }
        .pos-5 { top: 50%; left: 7%; }
        .pos-6 { top: 20%; left: 7%; }

        .lilly-controls { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;}
        .action-btn {
            border: 1px solid #555; background: #333; color: white;
            padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1rem;
        }
        .hint-btn { background: #3a7bd5; border: none; }
        .finish-btn { background: #ff5555; border: none; width: 100%; margin-top: 10px; max-width: 300px;}

        #lilly-words {
            margin-top: 20px; width: 90%; max-height: 100px; overflow-y: auto;
            border: 1px solid #333; padding: 10px; border-radius: 10px; font-size: 0.9rem; color: #aaa; text-align: center;
        }
        .found-word { display: inline-block; padding: 3px 8px; background: #333; margin: 3px; border-radius: 4px; color: white;}

        /* --- HINT MODAL --- */
        #hint-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 600; display: none;
            flex-direction: column; align-items: center; padding: 20px; overflow-y: auto;
        }
        .hint-table-container { overflow-x: auto; width: 100%; display: flex; justify-content: center; margin-bottom: 20px; }
        .hint-table { border-collapse: collapse; color: white; font-size: 0.9rem; }
        .hint-table th, .hint-table td { border: 1px solid #555; padding: 8px; text-align: center; }
        .hint-table th { background: #333; color: #ffd700; }
        .hint-table .row-header { font-weight: bold; background: #222; }
        .hint-table .sum-col { font-weight: bold; color: #aaa; }
        .two-letter-list { 
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width: 600px; 
            margin-bottom: 20px; color: #ddd; font-family: monospace; font-size: 1.1rem;
        }
        .two-letter-item { background: #222; padding: 5px 10px; border-radius: 5px; border: 1px solid #444; }

        /* --- STATS MODAL --- */
        #results-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 500; display: none;
            flex-direction: column; align-items: center; padding: 20px; overflow-y: auto;
        }
        .res-header { font-size: 1.5rem; color: #ffd700; margin-bottom: 20px; margin-top: 40px; text-align: center; }
        .res-score-circle {
            width: 120px; height: 120px; border-radius: 50%; border: 5px solid #538d4e;
            display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold;
            margin-bottom: 20px; color: white; background: #222;
        }
        .res-cols { display: flex; width: 100%; max-width: 600px; gap: 10px; flex-grow: 1; }
        .res-col { flex: 1; display: flex; flex-direction: column; border: 1px solid #444; border-radius: 10px; padding: 10px; height: 300px;}
        .res-col h3 { text-align: center; margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .res-list { overflow-y: auto; flex-grow: 1; font-size: 0.9rem; }
        .res-item { padding: 2px 5px; border-bottom: 1px solid #333; }
        .close-res-btn {
            margin-top: 20px; padding: 15px 40px; background: #538d4e; color: white; border: none;
            border-radius: 30px; font-weight: bold; font-size: 1.2rem; cursor: pointer;
        }

        /* --- HUD (SMART) --- */
        #status-panel {
            position: fixed; top: 70px; right: 20px;
            background: rgba(30, 30, 31, 0.95); border: 1px solid #555; border-radius: 8px;
            padding: 10px 15px; display: none; flex-direction: column; gap: 5px; z-index: 100;
            cursor: pointer; transition: all 0.3s ease;
        }
        .status-good { color: #538d4e; font-weight: bold; }
        .status-bad { color: #ff5555; font-weight: bold; }
        
        #status-panel.minimized {
            width: 40px; height: 40px; padding: 0; border-radius: 50%;
            justify-content: center; align-items: center; background: #333;
        }
        .hud-content { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .hud-icon { display: none; font-size: 1.5rem; }
        #status-panel.minimized .hud-content { display: none; }
        #status-panel.minimized .hud-icon { display: block; }

        /* --- KEYBOARD --- */
        #keyboard-container {
            display: none; width: 100%; max-width: 800px; padding: 5px;
            background-color: #121213; padding-bottom: 20px; border-top: 1px solid #333;
        }
        .keyboard-row { display: flex; justify-content: center; margin-bottom: 6px; width: 100%; }
        .key {
            position: relative; font-weight: bold; border: 0; padding: 1px; margin: 0 2px; height: 55px;
            border-radius: 4px; cursor: pointer; background-color: #333; color: white;
            flex: 1; font-size: 1.1rem; display: flex; justify-content: center; align-items: center;
        }
        .key-heatmap { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-wrap:wrap; z-index:1; pointer-events:none;}
        .key-pixel { flex-grow:1; flex-basis:calc(100%/4); background:#818384; border:0.5px solid #333; box-sizing:border-box;}
        .key-char { position:relative; z-index:2; pointer-events:none; text-shadow:0 0 3px black;}
        .key-large { flex: 1.5; font-size: 0.8rem; background: #555; }
        
        #msg-toast {
            position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
            background: white; color: black; padding: 15px 30px; border-radius: 30px;
            font-weight: bold; display: none; z-index: 2000; text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <h1>Lenis coole Spielesammlung üéÆ</h1>
        <button class="menu-btn" onclick="location.reload()">HAUPTMEN√ú</button>
    </header>

    <div id="msg-toast">Nachricht</div>

    <div id="main-menu">
        <div class="mode-card" onclick="openWurmdleSetup()">
            <span class="mode-icon">üêõ</span>
            <div class="mode-title">Wurmdle</div>
            <div class="mode-desc">Errate das Wort! (DE/EN)</div>
        </div>
        <div class="mode-card" onclick="openLillyLangSelect()">
            <span class="mode-icon">üê±</span>
            <div class="mode-title">Lillys Spelling Game</div>
            <div class="mode-desc">Finde die W√∂rter (DE/EN)</div>
        </div>
        <div id="loading-msg" style="color:#555; margin-top:20px;">Bereit.</div>
    </div>

    <div id="lang-modal">
        <h2 style="color:white; margin-bottom:30px;">W√§hle deine Sprache:</h2>
        <div class="lang-card" onclick="selectLillyLang('de')">üá©üá™ DEUTSCH</div>
        <div class="lang-card" onclick="selectLillyLang('en')">üá∫üá∏ ENGLISH</div>
        <button class="close-res-btn" style="background:#555; margin-top:30px;" onclick="document.getElementById('lang-modal').style.display='none'">Abbrechen</button>
    </div>

    <div id="status-panel" onclick="toggleHUD()" title="Klicken zum Verkleinern/Vergr√∂√üern">
        <div class="hud-content">
            <div style="display:flex; justify-content:space-between; gap:15px; color:#aaa;">
                <span>Erledigt:</span><span style="color:white; font-weight:bold;" id="hud-progress">0/0</span>
            </div>
            <div style="display:flex; justify-content:space-between; gap:15px; color:#aaa;">
                <span>Versuche:</span><span style="color:white; font-weight:bold;" id="hud-guesses">0</span>
            </div>
            <div style="margin-top:5px; border-top:1px solid #444; padding-top:5px; text-align:center;">
                <span id="hud-status-text" class="status-good">SIEG M√ñGLICH</span>
            </div>
            <div style="text-align:center; font-size:0.7rem; color:#666; margin-top:5px;">(Klick mich)</div>
        </div>
        <div class="hud-icon">üìä</div>
    </div>

    <div id="setup-area">
        <div class="setting-row">
            <span class="label">Sprache</span>
            <div class="toggle-group">
                <button class="lang-btn active" id="btn-de" onclick="loadWords('de')">DEUTSCH</button>
                <button class="lang-btn" id="btn-en" onclick="loadWords('en')">ENGLISH</button>
            </div>
        </div>
        <div class="setting-row"><span class="label">Anzahl Spiele</span><input type="number" id="board-count" value="4" min="1" max="64"></div>
        <div class="setting-row"><span class="label">Buchstaben</span><input type="number" id="letter-count" value="5"></div>
        <div class="setting-row"><span class="label" style="color:#b59f3b;">+ Extra Versuche</span><input type="number" id="extra-guesses" value="0"></div>
        <button class="start-btn" onclick="startWurmdle()">STARTEN</button>
    </div>

    <div id="game-scroll-area"><div id="game-container"></div></div>

    <div id="lilly-area">
        <div style="color:#ffd700; margin-bottom:10px;">Punkte: <span id="lilly-score">0</span></div>
        <div id="lilly-input"><span id="lilly-text"></span><span class="cursor"></span></div>
        <div id="honeycomb"></div>
        <div class="lilly-controls">
            <button class="action-btn" onclick="lillyDelete()">‚å´</button>
            <button class="action-btn" onclick="shuffleLilly()">Mischen üîÄ</button>
            <button class="action-btn" style="background:#538d4e;" onclick="lillySubmit()">ENTER</button>
            <button class="action-btn hint-btn" onclick="showHints()">TIPPS üí°</button>
        </div>
        <button class="action-btn finish-btn" onclick="finishLillyGame()">BEENDEN & AUSWERTUNG</button>
        <div id="lilly-words">Gefundene W√∂rter erscheinen hier...</div>
    </div>

    <div id="hint-modal">
        <div class="res-header">HINWEISE (GRID)</div>
        <div class="hint-table-container">
            <div id="grid-container"></div>
        </div>
        <div style="color:#aaa; margin-bottom:10px;">ZWEI BUCHSTABEN LISTE</div>
        <div id="two-letter-container" class="two-letter-list"></div>
        <button class="close-res-btn" onclick="document.getElementById('hint-modal').style.display='none'">SCHLIESSEN</button>
    </div>

    <div id="results-modal">
        <div class="res-header" id="res-header-text">SPIEL BEENDET</div>
        <div class="res-score-circle" id="res-final-score">0</div>
        <div style="color:#aaa; margin-bottom:20px;">PUNKTE (MAX <span id="res-max-pts">0</span>)</div>
        <div class="res-cols">
            <div class="res-col" style="border-color:#538d4e;">
                <h3 style="color:#538d4e;">GEFUNDEN (<span id="count-found">0</span>)</h3>
                <div class="res-list" id="list-found"></div>
            </div>
            <div class="res-col" style="border-color:#ff5555;">
                <h3 style="color:#ff5555;">VERPASST (<span id="count-missed">0</span>)</h3>
                <div class="res-list" id="list-missed"></div>
            </div>
        </div>
        <button class="close-res-btn" onclick="location.reload()">ZUR√úCK ZUM MEN√ú</button>
    </div>

    <div id="keyboard-container"></div>

    <script>
        /* --- DATEN & VARS --- */
        let currentLang = 'de';
        let cleanWordList = [];
        // Wurmdle Vars
        let gameWords = []; let games = []; let wordLength=5; let maxGuesses=6; let currentGuess=""; 
        let isGameActive = false; let totalGames=4; let activeMode = null;
        // Lilly Vars
        let lillyLetters = []; let lillyCenter = ""; let lillyFound = []; let lillyScore = 0; 
        let validLillyWords = []; let maxLillyPoints = 0;

        const keysDE = ["QWERTZUIOP", "ASDFGHJKL", "YXCVBNM"];
        const keysEN = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];

        /* --- INIT --- */
        window.onload = () => {
            setTimeout(() => loadWords('de'), 100);
            
            document.addEventListener('keydown', (e) => {
                const key = e.key.toUpperCase();
                if(activeMode === 'wurmdle') {
                    if (key === 'ENTER') { handleKey('ENTER'); e.preventDefault(); }
                    else if (key === 'BACKSPACE') { handleKey('BACK'); e.preventDefault(); }
                    else if (/^[A-Z]$/.test(key) && !e.ctrlKey) { handleKey(key); }
                } else if(activeMode === 'lilly') {
                    if (key === 'ENTER') { lillySubmit(); e.preventDefault(); }
                    else if (key === 'BACKSPACE') { lillyDelete(); e.preventDefault(); }
                    else if (/^[A-Z]$/.test(key) && !e.ctrlKey) { lillyType(key); }
                }
            });
        };

        function toggleHUD() {
            document.getElementById('status-panel').classList.toggle('minimized');
        }

        /* --- WORD LOADING --- */
        async function loadWords(lang) {
            currentLang = lang;
            const msg = document.getElementById('loading-msg');
            msg.innerText = "Lade W√∂rterbuch...";
            
            if(document.getElementById('btn-de')) {
                document.getElementById('btn-de').className = lang === 'de' ? 'lang-btn active' : 'lang-btn';
                document.getElementById('btn-en').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
            }

            try {
                const filename = (lang === 'de') ? 'de.txt' : 'en.txt';
                const response = await fetch(filename);
                if (!response.ok) throw new Error("Offline/Fehler");
                const text = await response.text();
                const lines = text.split('\n');
                
                cleanWordList = [];
                for (let i = 0; i < lines.length; i++) {
                    let w = lines[i].trim().toUpperCase();
                    if (w.length >= 3 && w.length <= 20 && /^[A-Z]+$/.test(w)) {
                        cleanWordList.push(w);
                    }
                }
                msg.innerText = `${cleanWordList.length} W√∂rter bereit.`;
                if(document.querySelector('.start-btn')) document.querySelector('.start-btn').innerText = "STARTEN";

            } catch (error) {
                console.error(error);
                msg.innerText = "Fehler beim Laden!";
                alert("Fehler: " + error.message);
            }
        }

        /* --- NAVIGATION --- */
        async function openWurmdleSetup() {
            await loadWords('de');
            if(cleanWordList.length === 0) return;
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('setup-area').style.display = 'flex';
        }

        /* NEU: LILLY LANGUAGE SELECTION */
        function openLillyLangSelect() {
             document.getElementById('lang-modal').style.display = 'flex';
        }
        
        function selectLillyLang(lang) {
             document.getElementById('lang-modal').style.display = 'none';
             startLillyGame(lang);
        }

        /* ================= WURMDLE LOGIC ================= */
        function startWurmdle() {
            activeMode = 'wurmdle';
            totalGames = parseInt(document.getElementById('board-count').value);
            wordLength = parseInt(document.getElementById('letter-count').value);
            const extra = parseInt(document.getElementById('extra-guesses').value) || 0;

            gameWords = cleanWordList.filter(w => w.length === wordLength);
            if (gameWords.length < totalGames) { alert("Zu wenige W√∂rter!"); return; }

            maxGuesses = wordLength + totalGames + extra;
            if(totalGames > 10 && extra === 0) maxGuesses += 2;

            isGameActive = true;
            document.documentElement.style.setProperty('--col-count', wordLength);

            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('game-scroll-area').style.display = 'flex';
            document.getElementById('keyboard-container').style.display = 'block';
            document.getElementById('status-panel').style.display = 'flex';
            document.getElementById('status-panel').classList.remove('minimized');

            games = []; currentGuess = "";
            const container = document.getElementById('game-container');
            container.innerHTML = '';

            for (let i = 0; i < totalGames; i++) {
                const randomWord = gameWords[Math.floor(Math.random() * gameWords.length)];
                games.push({ id: i, word: randomWord, guesses: [], solved: false });
                
                let html = `
                <div class="board-card" id="card-${i}">
                    <div class="board-header"><span>SPIEL ${i+1}</span><button class="help-btn" onclick="giveHint(${i})">üí°</button></div>
                    <div class="board" id="board-${i}">`;
                for (let r = 0; r < maxGuesses * wordLength; r++) html += `<div class="tile" id="tile-${i}-${r}"></div>`;
                html += `</div><div class="solution-text" id="sol-${i}"></div></div>`;
                container.innerHTML += html;
            }
            createKeyboard(); updateHUD();
        }

        function updateHUD() {
            const solvedCount = games.filter(g => g.solved).length;
            let usedGuesses = games.length > 0 ? games[0].guesses.length : 0;
            const remainingGuesses = maxGuesses - usedGuesses;
            const remainingGames = totalGames - solvedCount;
            document.getElementById('hud-progress').innerText = `${solvedCount} / ${totalGames}`;
            document.getElementById('hud-guesses').innerText = remainingGuesses;
            const st = document.getElementById('hud-status-text');
            if (remainingGuesses < remainingGames) { st.innerText = "NICHT SCHAFFBAR"; st.className = "status-bad"; }
            else { st.innerText = "SIEG M√ñGLICH"; st.className = "status-good"; }
        }

        function giveHint(gameId) {
            if(!isGameActive) return;
            const game = games[gameId];
            if(game.solved || game.guesses.length >= maxGuesses) return;
            const idx = Math.floor(Math.random() * wordLength);
            showToast(`Tipp: "${game.word[idx]}" an Pos ${idx+1}`);
        }

        function createKeyboard() {
            const kb = document.getElementById('keyboard-container'); kb.innerHTML = '';
            const layout = (currentLang === 'de') ? keysDE : keysEN;
            layout.forEach((rowStr, idx) => {
                const row = document.createElement('div'); row.className = 'keyboard-row';
                if (idx === layout.length - 1) appendKey(row, 'ENTER', 'key-large', ()=>handleKey('ENTER'));
                for (let char of rowStr) {
                    const k = document.createElement('div'); k.className='key'; k.id=`key-${char}`; k.onclick=()=>handleKey(char);
                    let hm = `<div class="key-heatmap">`;
                    for(let i=0; i<totalGames; i++) hm += `<div class="key-pixel" id="pixel-${char}-${i}"></div>`;
                    k.innerHTML = hm + `</div><div class="key-char">${char}</div>`;
                    row.appendChild(k);
                }
                if (idx === layout.length - 1) appendKey(row, '‚å´', 'key-large', ()=>handleKey('BACK'));
                kb.appendChild(row);
            });
        }
        function appendKey(parent, text, cls, action) {
            const b = document.createElement('button'); b.className = 'key '+cls; b.innerText = text; b.onclick = action; parent.appendChild(b);
        }

        function handleKey(key) {
            if (key === 'ENTER') submitGuess();
            else if (key === 'BACK') { currentGuess = currentGuess.slice(0, -1); updateGridPreview(); }
            else { if (currentGuess.length < wordLength) { currentGuess += key; updateGridPreview(); } }
        }

        function updateGridPreview() {
            games.forEach(game => {
                if (game.solved || game.guesses.length >= maxGuesses) return;
                const startIdx = game.guesses.length * wordLength;
                for(let i=0; i<wordLength; i++) {
                     const tile = document.getElementById(`tile-${game.id}-${startIdx + i}`);
                     tile.classList.remove('shake-effect');
                     tile.innerText = currentGuess[i] || "";
                     tile.style.borderColor = currentGuess[i] ? "#888" : "#3a3a3c";
                }
            });
        }

        function submitGuess() {
            if (currentGuess.length !== wordLength) { showToast("Zu kurz!"); return; }
            if (!gameWords.includes(currentGuess)) { showToast("Wort unbekannt!"); shakeRows(); return; }

            games.forEach(game => {
                if (game.solved || game.guesses.length >= maxGuesses) return;
                const wArr = game.word.split(''); const gArr = currentGuess.split('');
                const startIdx = game.guesses.length * wordLength;
                let status = new Array(wordLength).fill(0);
                for (let i=0; i<wordLength; i++) if (gArr[i]===wArr[i]) { status[i]=2; wArr[i]=null; gArr[i]=null; }
                for (let i=0; i<wordLength; i++) if (gArr[i]!==null && wArr.indexOf(gArr[i])>-1) { status[i]=1; wArr[wArr.indexOf(gArr[i])]=null; }

                for (let i=0; i<wordLength; i++) {
                    const t = document.getElementById(`tile-${game.id}-${startIdx + i}`);
                    t.style.borderColor="transparent";
                    if(status[i]===2) t.classList.add('correct');
                    else if(status[i]===1) t.classList.add('present');
                    else t.classList.add('absent');
                }
                game.guesses.push(currentGuess);
                if (currentGuess === game.word) { game.solved = true; document.getElementById(`card-${game.id}`).classList.add('solved-overlay'); }
            });

            updateKeyboardColors(); currentGuess = ""; updateHUD();
            if (games.every(g => g.solved || g.guesses.length >= maxGuesses)) {
                if (games.every(g => g.solved)) showToast("üéâ SUPER LENI HAT GEWONNEN! üéâ");
                else {
                    showToast("Vorbei!");
                    games.forEach(g => { if(!g.solved) { const s=document.getElementById(`sol-${g.id}`); s.innerText=g.word; s.style.display="block"; } });
                }
                isGameActive = false;
            }
        }
        function shakeRows() { games.forEach(g => { if(!g.solved && g.guesses.length < maxGuesses) { const s = g.guesses.length*wordLength; for(let i=0;i<wordLength;i++) { const t=document.getElementById(`tile-${g.id}-${s+i}`); t.classList.remove('shake-effect'); void t.offsetWidth; t.classList.add('shake-effect'); } } }); }
        function updateKeyboardColors() {
            games.forEach(g => {
                let status = {};
                g.guesses.forEach(guess => {
                     const wArr = g.word.split(''); const gArr = guess.split('');
                     let loc = new Array(wordLength).fill(1);
                     for(let i=0; i<wordLength; i++) if(gArr[i]===wArr[i]) { loc[i]=3; wArr[i]=null; gArr[i]=null; }
                     for(let i=0; i<wordLength; i++) if(gArr[i] && wArr.includes(gArr[i])) loc[i]=2;
                     guess.split('').forEach((c,i) => { if(loc[i]>(status[c]||0)) status[c]=loc[i]; });
                });
                for(const [c,s] of Object.entries(status)) {
                    const p = document.getElementById(`pixel-${c}-${g.id}`);
                    if(p) p.style.backgroundColor = (s===3)?'#538d4e':(s===2)?'#b59f3b':(s===1)?'#3a3a3c':'#818384';
                }
            });
        }

        /* ================= LILLY SPELLING LOGIC ================= */
        async function startLillyGame(lang) {
            showToast("Lade W√∂rterbuch...");
            await loadWords(lang);

            if(cleanWordList.length === 0) return;
            activeMode = 'lilly';
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('lilly-area').style.display = 'flex';
            
            // 1. Finde ein Pangramm
            let pangrams = cleanWordList.filter(w => new Set(w.split('')).size === 7);
            if(pangrams.length === 0) { alert("Kein Pangramm gefunden in " + lang); return; }
            
            const sourceWord = pangrams[Math.floor(Math.random() * pangrams.length)];
            const uniqueChars = Array.from(new Set(sourceWord.split('')));
            
            // Mischen
            for (let i = uniqueChars.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [uniqueChars[i], uniqueChars[j]] = [uniqueChars[j], uniqueChars[i]];
            }

            lillyCenter = uniqueChars[0];
            lillyLetters = uniqueChars;
            lillyFound = []; lillyScore = 0; maxLillyPoints = 0;

            validLillyWords = cleanWordList.filter(w => {
                if(w.length < 4) return false;
                if(!w.includes(lillyCenter)) return false;
                for(let char of w) if(!lillyLetters.includes(char)) return false;
                return true;
            });

            validLillyWords.forEach(w => maxLillyPoints += calcWordScore(w));

            renderLillyBoard();
            updateLillyScore();
        }

        /* --- HINT LOGIC (THE GRID) --- */
        function showHints() {
            let matrix = {};
            let lengths = new Set();
            let letters = new Set();
            let twoLetterCounts = {};

            validLillyWords.forEach(w => {
                const len = w.length;
                const char = w[0];
                const twoChar = w.substring(0, 2);

                lengths.add(len);
                letters.add(char);

                if(!matrix[char]) matrix[char] = {};
                if(!matrix[char][len]) matrix[char][len] = 0;
                matrix[char][len]++;

                if(!twoLetterCounts[twoChar]) twoLetterCounts[twoChar] = 0;
                twoLetterCounts[twoChar]++;
            });

            const sortedLengths = Array.from(lengths).sort((a,b)=>a-b);
            const sortedLetters = Array.from(letters).sort();

            let html = '<table class="hint-table"><thead><tr><th></th>';
            sortedLengths.forEach(l => html += `<th>${l}</th>`);
            html += '<th class="sum-col">Œ£</th></tr></thead><tbody>';

            sortedLetters.forEach(char => {
                html += `<tr><td class="row-header">${char}</td>`;
                let rowSum = 0;
                sortedLengths.forEach(len => {
                    const count = matrix[char][len] || "-";
                    if(count !== "-") rowSum += count;
                    html += `<td>${count}</td>`;
                });
                html += `<td class="sum-col">${rowSum}</td></tr>`;
            });
            html += '</tbody></table>';

            document.getElementById('grid-container').innerHTML = html;

            let tlHtml = "";
            Object.keys(twoLetterCounts).sort().forEach(tl => {
                tlHtml += `<div class="two-letter-item">${tl}-${twoLetterCounts[tl]}</div>`;
            });
            document.getElementById('two-letter-container').innerHTML = tlHtml;

            document.getElementById('hint-modal').style.display = 'flex';
        }

        function renderLillyBoard() {
            const container = document.getElementById('honeycomb');
            container.innerHTML = '';
            
            lillyLetters.forEach((char, index) => {
                const btn = document.createElement('div');
                btn.className = `hex-btn pos-${index}`;
                if(index === 0) btn.classList.add('hex-center'); 
                btn.innerText = char;
                btn.onclick = () => lillyType(char);
                container.appendChild(btn);
            });
        }

        function lillyType(char) {
            if(lillyLetters.includes(char)) {
                document.getElementById('lilly-text').innerText += char;
            }
        }
        function lillyDelete() {
            let t = document.getElementById('lilly-text').innerText;
            document.getElementById('lilly-text').innerText = t.slice(0, -1);
        }
        function shuffleLilly() {
            let outer = lillyLetters.slice(1);
            for (let i = outer.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [outer[i], outer[j]] = [outer[j], outer[i]];
            }
            lillyLetters = [lillyLetters[0], ...outer];
            renderLillyBoard();
        }

        function calcWordScore(word) {
            if(word.length === 4) return 1;
            let pts = word.length;
            const unique = new Set(word.split('')).size;
            if(unique === 7) pts += 7;
            return pts;
        }

        function lillySubmit() {
            const textEl = document.getElementById('lilly-text');
            const word = textEl.innerText;
            
            if(word.length < 4) { showToast("Zu kurz (min 4)"); return; }
            if(!word.includes(lillyCenter)) { showToast("Muss Gelb enthalten!"); return; }
            if(lillyFound.includes(word)) { showToast("Schon gefunden!"); textEl.innerText=""; return; }
            
            if(validLillyWords.includes(word)) {
                const pts = calcWordScore(word);
                const isPangram = (new Set(word.split('')).size === 7);
                if(isPangram) { showToast(`ü¶Ñ PANGRAMM! +${pts} ü¶Ñ`); }
                else { showToast(`Super! +${pts}`); }

                lillyFound.push(word);
                lillyScore += pts;
                updateLillyScore();
                
                const span = document.createElement('span');
                span.className = 'found-word';
                span.innerText = word + (isPangram ? " üåü" : "");
                document.getElementById('lilly-words').prepend(span); 
                textEl.innerText = "";
                
                // WIN CHECK
                if(lillyFound.length === validLillyWords.length) {
                    showToast("üëë ALLES GEFUNDEN! üëë");
                    setTimeout(() => finishLillyGame(true), 1500);
                }

            } else {
                showToast("Nicht in Liste.");
                textEl.classList.add('shake-effect');
                setTimeout(()=>textEl.classList.remove('shake-effect'), 500);
            }
        }

        function updateLillyScore() {
            document.getElementById('lilly-score').innerText = lillyScore;
        }

        function finishLillyGame(isWin = false) {
            const modal = document.getElementById('results-modal');
            const listFound = document.getElementById('list-found');
            const listMissed = document.getElementById('list-missed');
            
            const header = document.getElementById('res-header-text');
            if(isWin === true) {
                header.innerText = "SUPER LENI HAT GEWONNEN!";
                header.style.color = "#538d4e";
            } else {
                header.innerText = "SPIEL BEENDET";
                header.style.color = "#ffd700";
            }
            
            const finalPercent = Math.round((lillyScore / maxLillyPoints) * 100);
            document.getElementById('res-final-score').innerText = finalPercent;
            document.getElementById('res-max-pts').innerText = maxLillyPoints;

            document.getElementById('count-found').innerText = lillyFound.length;
            document.getElementById('count-missed').innerText = validLillyWords.length - lillyFound.length;

            listFound.innerHTML = "";
            lillyFound.sort().forEach(w => {
                listFound.innerHTML += `<div class="res-item" style="color:#538d4e;">${w} (${calcWordScore(w)})</div>`;
            });

            listMissed.innerHTML = "";
            const missed = validLillyWords.filter(w => !lillyFound.includes(w)).sort();
            missed.forEach(w => {
                listMissed.innerHTML += `<div class="res-item" style="color:#aaa;">${w} (${calcWordScore(w)})</div>`;
            });

            modal.style.display = 'flex';
        }

        function showToast(txt) {
            const t = document.getElementById('msg-toast'); t.innerText = txt; t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 2000);
        }
    </script>
</body>
</html>
